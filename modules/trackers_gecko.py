from selenium import webdriver
from selenium.common.exceptions import TimeoutException, WebDriverException, JavascriptException, \
                                        InvalidArgumentException
from itertools import product
from urllib.parse import urlparse
from re import compile, IGNORECASE
from requests import get
from requests.exceptions import ConnectionError, ReadTimeout
from time import sleep
from json import loads

tracker_set = {'Google Analytics': ['google-analytics.com'], 'Google Static': ['gstatic.com'], 'Google Tag Manager': ['googletagmanager.com', 'googletagservices.com'], 'Google Fonts': ['fonts.googleapis.com'], 'Facebook': ['facebook.com', 'facebook.net'], 'Google': ['google.at', 'google.be', 'google.ca', 'google.ch', 'google.co.id', 'google.co.in', 'google.co.jp', 'google.co.ma', 'google.co.th', 'google.co.uk', 'google.com', 'google.com.ar', 'google.com.au', 'google.com.br', 'google.com.mx', 'google.com.tr', 'google.com.tw', 'google.com.ua', 'google.cz', 'google.de', 'google.dk', 'google.dz', 'google.es', 'google.fi', 'google.fr', 'google.gr', 'google.hu', 'google.ie', 'google.it', 'google.nl', 'google.no', 'google.pl', 'google.pt', 'google.ro', 'google.rs', 'google.ru', 'google.se', 'google.tn'], 'DoubleClick': ['2mdn.net', 'doubleclick.net', 'invitemedia.com'], 'Google APIs': ['googleapis.com'], 'YouTube': ['googlevideo.com', 'youtube-nocookie.com', 'youtube.com', 'ytimg.com'], 'Amazon Advertising': ['amazon-adsystem.com'], 'Google User Content': ['googleusercontent.com'], 'ScoreCard Research Beacon': ['scorecardresearch.com', 'scoreresearch.com', 'scrsrch.com', 'securestudies.com'], 'Google AdServices': ['googleadservices.com'], 'Amazon CloudFront': ['cloudfront.net'], 'CloudFlare': ['cloudflare.com', 'cloudflare.net'], 'Twitter': ['t.co', 'twimg.com', 'twitter.com'], 'Google Syndication': ['googlesyndication.com'], 'Google Photos': ['ggpht.com'], 'Criteo': ['criteo.com', 'criteo.net'], 'Amazon Web Services': ['amazonaws.com', 'amazonwebservices.com', 'awsstatic.com'], 'Bing Ads': ['bat.r.msn.com', 'bing.com', 'bing.net'], 'New Relic': ['d1ros97qkrwjf5.cloudfront.net', 'newrelic.com', 'nr-data.net'], 'Adobe Audience Manager': ['adobe.com', 'demdex.net', 'everestjs.net', 'everesttech.net'], 'AppNexus': ['adnxs.com', 'adnxs.net'], 'Yandex Metrika': ['mc.yandex.ru'], 'Amazon CDN': ['images-amazon.com', 'media-amazon.com', 'ssl-images-amazon.com'], 'Facebook CDN': ['fbcdn.net', 'fbsbx.com'], 'Twitter Syndication': ['syndication.twitter.com'], 'Bootstrap CDN': ['bootstrapcdn.com'], 'Quantcast': ['quantcast.com', 'quantserve.com'], 'Akamai Technologies': ['abmr.net', 'akamai.net', 'akamaihd.net', 'akamaized.net', 'akstat.io', 'edgekey.net', 'edgesuite.net', 'imiclk.com'], 'Hotjar': ['hotjar.com'], 'ChartBeat': ['chartbeat.com', 'chartbeat.net'], 'Pinterest': ['pinimg.com', 'pinterest.com'], 'Taboola': ['basebanner.com', 'taboola.com', 'taboolasyndication.com'], 'IAB Consent': ['consensu.org'], 'Yandex': ['awaps.yandex.ru', 'd31j93rd8oukbv.cloudfront.net', 'webvisor.org', 'yandex.net', 'yandex.ru', 'yastatic.net'], 'Outbrain': ['outbrain.com', 'outbrainimg.com'], 'Index Exchange': ['casalemedia.com', 'indexww.com'], 'jQuery': ['cdnjquery.com', 'jquery.com'], 'Tealium': ['tealium.com', 'tealium.hs.llnwd.net', 'tealiumiq.com', 'tiqcdn.com'], 'Yahoo!': ['tumblr.com', 'yahoo.com', 'yahooapis.com', 'yimg.com'], 'AddThis': ['addthis.com', 'addthiscdn.com', 'addthisedge.com'], 'jsDelivr': ['jsdelivr.net'], 'LiveInternet': ['yadro.ru'], 'Adobe Dynamic Tag Management': ['adobedtm.com'], 'Optimizely': ['optimizely.com'], 'Microsoft Services': ['azurewebsites.net', 'cloudapp.net', 'gfx.ms', 'live.com', 'microsoft.com', 'microsoftonline-p.com', 'microsoftonline.com', 'microsofttranslator.com', 'msecnd.net', 'msedge.net', 'msocdn.com', 'onestore.ms', 's-microsoft.com', 'trouter.io', 'windows.net'], 'Rubicon': ['dpclk.com', 'mobsmith.com', 'nearbyad.com', 'rubiconproject.com'], 'Twitter Advertising': ['ads-twitter.com'], 'Adobe Analytics': ['2o7.net', 'du8783wkf05yr.cloudfront.net', 'hitbox.com', 'imageg.net', 'nedstat.com', 'omtrdc.net', 'sitestat.com'], 'eBay Stats': ['classistatic.de', 'ebay-us.com', 'ebay.com', 'ebay.de', 'ebayclassifiedsgroup.com', 'ebaycommercenetwork.com', 'ebaydesc.com', 'ebayimg.com', 'ebayrtm.com', 'ebaystatic.com'], 'Krux Digital': ['krxd.net'], 'NetRatings SiteCensus': ['glanceguide.com', 'imrworldwide.com', 'vizu.com'], 'VKontakte': ['userapi.com', 'vk.com', 'vkontakte.ru'], 'Kaspersky Labs': ['kaspersky-labs.com'], 'Mail.Ru Group': ['imgsmail.ru', 'mail.ru', 'mradx.net', 'odnoklassniki.ru', 'ok.ru'], 'Gravatar': ['gravatar.com'], 'fontawesome.com': ['fontawesome.com'], 'INFOnline': ['ioam.de', 'iocnt.net', 'ivwbox.de'], 'Gemius': ['gemius.pl'], 'Reddit': ['redd.it', 'reddit-image.s3.amazonaws.com', 'reddit.com', 'redditmedia.com', 'redditstatic.com'], 'BlueKai': ['bkrtx.com', 'bluekai.com'], 'PubMatic': ['pubmatic.com'], 'WordPress Stats': ['w.org', 'wordpress.com', 'wp.com'], 'Acceptable Ads Exchange': ['aaxads.com'], 'Adform': ['adform.net', 'adformdsp.net', 'seadform.net'], 'TradeDesk': ['adsrvr.org'], 'OneSignal': ['onesignal.com', 'os.tc'], 'OpenX': ['odnxs.net', 'openx.net', 'openx.org', 'openxenterprise.com', 'servedbyopenx.com'], 'Typekit by Adobe': ['typekit.com', 'typekit.net'], 'Facebook Social Graph': ['graph.facebook.com'], 'Integral Ad Science': ['adsafeprotected.com', 'iasds01.com'], 'SOASTA mPulse': ['go-mpulse.net', 'mpstat.us'], 'Disqus': ['disqus.com', 'disquscdn.com'], 'ExoClick': ['exdynsrv.com', 'exoclick.com', 'exosrv.com'], 'SMART AdServer': ['sascdn.com', 'smartadserver.com', 'styria-digital.com', 'yoc-adserver.com'], 'Alexa Metrics': ['alexametrics.com', 'd31qbv1cthcecs.cloudfront.net', 'd5nxst8fruw4z.cloudfront.net'], 'Jetpack': ['pixel.wp.com', 'stats.wp.com'], 'PayPal': ['paypal.com', 'paypalobjects.com'], 'LiveRamp': ['pippio.com', 'rapleaf.com', 'rlcdn.com'], 'AT Internet': ['ati-host.net', 'aticdn.net', 'xiti.com'], 'Mediascope': ['tns-counter.ru'], 'Advertising.com': ['adsdk.com', 'advertising.com', 'aol.com', 'atwola.com', 'pictela.net'], 'Polyfill': ['polyfill.io'], 'Moat': ['moatads.com', 'moatpixel.com'], 'RTB House': ['creativecdn.com'], 'Crazy Egg': ['cetrk.com', 'crazyegg.com', 'dnn506yrbagrg.cloudfront.net'], 'Lotame': ['crwdcntrl.net'], 'Fastly': ['fastly.net', 'fastlylb.net'], 'Instagram': ['cdninstagram.com', 'instagram.com'], 'WikiMedia': ['wikimedia.org', 'wikipedia.org', 'wikiquote.org'], 'Mixpanel': ['mixpanel.com', 'mxpnl.com', 'mxpnl.net'], 'Aggregate Knowledge': ['agkn.com'], 'Alibaba': ['alibaba.com', 'alicdn.com'], 'Google Translate': ['translate.google.com'], 'Yandex.Direct': ['an.webvisor.org', 'an.yandex.ru', 'bs.yandex.ru'], 'JW Player': ['d21rhj7n383afu.cloudfront.net', 'jwpcdn.com', 'jwplatform.com', 'jwplayer.com', 'jwpltx.com', 'jwpsrv.com'], 'Segment': ['d2dq2ahtl5zl1z.cloudfront.net', 'd47xnnr8b1rki.cloudfront.net', 'segment.com', 'segment.io'], 'PornHub': ['phncdn.com', 'pornhub.com'], 'Imgur': ['imgur.com'], 'Didomi': ['privacy-center.org'], 'Yahoo! Japan': ['storage-yahoo.jp', 'yahoo.co.jp', 'yahooapis.jp', 'yimg.jp', 'yjtag.jp'], 'LinkedIn Analytics': ['snap.licdn.com'], 'MarkMonitor': ['caanalytics.com', 'mmstat.com'], 'videoplayerhub.com': ['videoplayerhub.com'], 'Weborama': ['adrcdn.com', 'adrcntr.com', 'weborama.com', 'weborama.fr'], 'LinkedIn Marketing Solutions': ['bizographics.com'], 'Snapchat For Business': ['sc-static.net', 'snapchat.com'], 'Amazon Payments': ['amazonpay.com', 'payments-amazon.com'], 'Amplitude': ['amplitude.com', 'd24n15hnbwhuhn.cloudfront.net'], 'Commanders Act (formerly Tag Commander)': ['commander1.com', 'tagcommander.com'], 'SpotX': ['spotx.tv', 'spotxcdn.com', 'spotxchange.com'], 'Zendesk CDN': ['zdassets.com'], 'Bidswitch': ['bidswitch.net', 'exe.bid'], 'Oath': ['oath.com'], 'Gigya': ['gigcount.com', 'gigya.com'], 'Digital Window': ['dwin1.com'], 'cXense': ['cxense.com'], 'Branch': ['app.link', 'branch.io'], 'Optanaon by OneTrust': ['cookielaw.org'], 'Visual Website Optimizer': ['d5phz18u4wuww.cloudfront.net', 'visualwebsiteoptimizer.com', 'wingify.com'], 'Parse.ly': ['d1z2jf7jlzjs58.cloudfront.net', 'parsely.com'], 'Usabilla': ['usabilla.com'], 'sovrn': ['d3pkae9owd2lcf.cloudfront.net', 'lijit.com'], 'Teads': ['teads.tv'], 'Ensighten': ['ensighten.com'], 'MediaMath': ['mathads.com', 'mathtag.com'], 'AB Tasty': ['abtasty.com', 'd1447tq2m68ekg.cloudfront.net'], 'ACPM': ['acpm.fr'], 'unpkg': ['unpkg.com'], 'Rambler': ['rambler.ru', 'top100.ru'], 'TripleLift': ['3lift.com', 'd3iwjrnl4m67rd.cloudfront.net', 'triplelift.com'], 'Qualtrics': ['qualtrics.com'], 'Amazon.com': ['amazon.ca', 'amazon.co.jp', 'amazon.co.uk', 'amazon.com', 'amazon.de', 'amazon.es', 'amazon.fr', 'amazon.it', 'd3io1k5o0zdpqr.cloudfront.net'], 'Traffic Stars': ['trafficstars.com', 'tsyndicate.com'], 'ShareThis': ['sharethis.com'], 'Baidu Ads': ['baidu.com', 'baidustatic.com'], 'Adition': ['adition.com'], 'OneTrust': ['onetrust.com'], 'Traffic Factory': ['trafficfactory.biz'], 'TrafficJunky': ['trafficjunky.net'], 'Zendesk': ['zendesk.com'], 'GitHub': ['github.com', 'githubassets.com', 'githubusercontent.com'], 'MailChimp': ['chimpstatic.com', 'list-manage.com', 'mailchimp.com'], 'Bazaarvoice': ['bazaarvoice.com'], 'LinkedIn': ['bizo.com', 'licdn.com', 'linkedin.com', 'lynda.com'], 'ContentSquare': ['contentsquare.net'], 'SkimLinks': ['redirectingat.com', 'skimlinks.com', 'skimresources.com'], 'Evidon': ['betrad.com', 'evidon.com'], 'Stripe': ['stripe.com', 'stripe.network'], 'Media.net': ['media.net'], 'etahub.com': ['etahub.com'], 'eStat': ['cybermonitor.com', 'estat.com'], 'Twitter Analytics': ['analytics.twitter.com'], 'xvideos.com': ['xvideos-cdn.com', 'xvideos.com'], 'Kameleoon': ['kameleoon.com', 'kameleoon.eu'], 'Pingdom': ['pingdom.net'], 'Xaxis': ['mookie1.com'], 'xHamster': ['xhamster.com', 'xhamsterlive.com', 'xhamsterpremium.com', 'xhcdn.com'], 'Shopify Stats': ['shopify.com'], 'Sourcepoint': ['decenthat.com', 'summerhamster.com'], 'Zencoder': ['zencdn.net'], 'Mail.Ru Banner Network': ['ad.mail.ru'], 'Azure CDN': ['azureedge.net'], 'Twitch CDN': ['jtvnw.net', 'ttvnw.net', 'twitchcdn.net', 'twitchsvc.net'], 'MaxCDN': ['maxcdn.com', 'netdna-cdn.com', 'netdna-ssl.com'], 'AMP Project': ['ampproject.org'], 'Bounce Exchange': ['bounceexchange.com'], 'LinkedIn Ads': ['ads.linkedin.com'], 'Piano': ['npttech.com', 'tinypass.com'], 'AdRoll': ['adroll.com'], 'MarketGid': ['dt00.net', 'dt07.net', 'marketgid.com', 'mgid.com'], 'stripst.com': ['stripst.com'], 'Webtrekk': ['d1r27qvpjiaqj3.cloudfront.net', 'mateti.net', 'wbtrk.net', 'wcfbc.net', 'webtrekk-asia.net', 'webtrekk.com', 'webtrekk.de', 'webtrekk.net', 'wt-eu02.net', 'wt-safetag.com'], 'eXelate': ['exelator.com'], 'Kenshoo': ['xg4ken.com'], 'The ADEX': ['theadex.com'], 'Oracle Maxymiser': ['maxymiser.hs.llnwd.net', 'maxymiser.net'], 'DataDome': ['datadome.co'], 'office365.com': ['office365.com'], 'ShareThrough': ['shareth.ru', 'sharethrough.com'], 'AppDynamics': ['appdynamics.com', 'de8of677fyt0b.cloudfront.net', 'eum-appdynamics.com'], 'TrustArc': ['trustarc.com', 'truste.com'], 'AddToAny': ['addtoany.com'], 'Perimeterx': ['perimeterx.net'], 'Cedexis Radar': ['cedexis-radar.net', 'cedexis-test.com', 'cedexis.com', 'cedexis.fastlylb.net', 'cedexis.net'], 'Cookiebot': ['cookiebot.com'], 'Dotomi': ['dotomi.com', 'dtmc.com', 'dtmpub.com'], 'ImgIX': ['imgix.net'], 'OnThe.io': ['onthe.io'], 'Mediarithmics': ['mediarithmics.com'], 'Nugg.Ad': ['nuggad.net'], 'Trusted Shops': ['trustedshops.com'], 'HubSpot': ['hs-analytics.net', 'hs-scripts.com', 'hubapi.com', 'hubspot.com'], 'Meetrics': ['meetrics.net', 'mxcdn.net', 'research.de.com'], 'PulsePoint': ['contextweb.com', 'pulsepoint.com'], 'Histats': ['histats.com'], 'Permutive': ['permutive.com'], 'Nativo': ['ntv.io', 'postrelease.com'], 'LivePerson': ['liveperson.net', 'lpsnmedia.net'], 'JuicyAds': ['juicyads.com'], 'Yieldlab': ['yieldlab.net'], 'Admo.tv': ['admo.tv'], 'Turn Inc.': ['turn.com'], 'Intercom': ['intercom.io', 'intercomassets.com', 'intercomcdn.com'], 'ICF Technology': ['nsimg.net'], 'blogspot.com': ['blogblog.com', 'blogger.com', 'blogspot.com'], 'Improve Digital': ['360yield.com'], 'ADTECH': ['adtech.de', 'adtechus.com'], 'Sentry': ['ravenjs.com', 'sentry.io'], 'Sovrn OneTag': ['s-onetag.com'], 'Sailthru Horizon': ['sail-horizon.com', 'sail-personalize.com', 'sailthru.com'], 'iGoDigital': ['igodigital.com'], 'Rhythmone Beacon': ['1rx.io'], 'VigLink': ['viglink.com'], 'Visualstudio.com': ['visualstudio.com'], 'Medallia': ['kampyle.com'], 'PopAds': ['popads.net', 'popadscdn.net'], 'Whos.amung.us': ['amung.us'], 'Rakuten LinkShare': ['linksynergy.com'], 'Sizmek': ['serving-sys.com'], 'Keycdn': ['kxcdn.com'], 'Monotype GmbH': ['fonts.net'], 'Scarab Research': ['scarabresearch.com'], 'Statcounter': ['statcounter.com'], 'Flashtalking': ['flashtalking.com'], 'emetriq': ['emetriq.de'], 'Brightcove Player': ['brightcove.net'], 'Microsoft Ajax CDN': ['aspnetcdn.com'], 'SpeedCurve': ['speedcurve.com'], 'ClickTale': ['clicktale.com', 'clicktale.net', 'clicktale.pantherssl.com', 'clicktalecdn.sslcs.cdngc.net'], 'Vimeo': ['vimeo.com', 'vimeocdn.com'], 'Brightcove': ['brightcove.com'], 'Impact Radius': ['7eer.net', 'd3cxv97fi8q177.cloudfront.net', 'evyy.net', 'impactradius-event.com', 'impactradius-tag.com', 'impactradius.com', 'ojrq.net', 'r7ls.net'], 'Monetate': ['monetate.net'], 'Adobe Dynamic Media (Scene7)': ['scene7.com'], 'Baidu Static': ['bdimg.com', 'bdstatic.com'], 'Live Intent': ['liadm.com'], 'Sift Science': ['dtlilztwypawv.cloudfront.net', 'siftscience.com'], 'Marketo': ['marketo.com', 'marketo.net', 'mktoresp.com'], 'Keywee': ['keywee.co'], 'Quora': ['quora.com'], 'Linkpulse': ['lp4.io'], 'Trustpilot': ['trustpilot.com'], 'iAdvize': ['iadvize.com'], 'MicroAd': ['microad.co.jp', 'microad.jp', 'microad.net', 'microadinc.com'], 'Bugsnag': ['bugsnag.com', 'd2wy8f7a9ursnm.cloudfront.net'], 'VG Wort': ['vgwort.de'], 'Google Appspot': ['appspot.com'], 'Tapad': ['tapad.com'], 'Zopim': ['zopim.com'], 'Rakuten Display': ['mediaforge.com', 'rmtag.com'], 'district m': ['districtm.ca', 'districtm.io'], 'Hatena': ['hatena.ne.jp', 'st-hatena.com'], 'adtng.com': ['adtng.com'], 'Yieldlove': ['yieldlove-ad-serving.net', 'yieldlove.com'], 'Twitch': ['ext-twitch.tv', 'twitch.tv'], 'iSpot.tv': ['ispot.tv'], 'CQuotient': ['cquotient.com'], 'Cloudinary': ['cloudinary.com'], 'Hubvisor': ['hubvisor.io'], 'Dailymotion': ['dailymotion.com', 'dailymotionbus.com', 'dm-event.net', 'dmcdn.net'], 'Skype': ['skype.com', 'skypeassets.com'], 'Medigo': ['mediego.com'], 'Umeng': ['cnzz.com', 'umeng.com'], 'BBC': ['bbci.co.uk'], 'AdOcean': ['adocean.pl'], 'highwebmedia.com': ['highwebmedia.com'], 'Sortable': ['deployads.com'], 'Movable Ink': ['micpn.com'], 'Salesforce': ['force.com', 'salesforce.com'], 'Rackspace': ['rackcdn.com'], 'woopic.com': ['woopic.com'], 'ThreatMetrix': ['online-metrix.net'], 'MyFonts': ['myfonts.net'], 'Signal': ['btstatic.com', 'signal.co', 'thebrighttag.com'], 'Wikia Services': ['wikia-services.com'], 'Le Monde.fr': ['lemde.fr'], 'Stack Exchange': ['sstatic.net'], 'Captify': ['captifymedia.com', 'cpx.to'], 'Dynamic Yield': ['dynamicyield.com'], 'Schibsted Media Group': ['schibsted.com', 'schibsted.io'], 'AOL CDN': ['aolcdn.com'], 'ForeSee': ['4seeresults.com', 'foresee.com'], 'Plista': ['plista.com'], 'gumgum': ['gumgum.com'], 'Brandmetrics.com': ['brandmetrics.com'], 'Advanced Hosters': ['ahcdn.com', 'pix-cdn.org'], 'Stroer Digital Media': ['interactivemedia.net', 'stroeerdigitalgroup.de', 'stroeerdigitalmedia.de', 'stroeerdp.de', 'stroeermediabrands.de'], 'Digioh': ['digioh.com', 'lightboxcdn.com'], 'Salesforce Live Agent': ['liveagentforsalesforce.com', 'salesforceliveagent.com'], 'Certona': ['certona.net', 'res-x.com'], 'Embedly': ['embed.ly', 'embedly.com'], 'Orange': ['orange.fr', 'orangeads.fr'], 'xplosion': ['xplosion.de'], 'Wikia CDN': ['nocookie.net'], 'Mouseflow': ['mouseflow.com'], 'Yahoo! Ad Manager Plus': ['pr-bh.ybp.yahoo.com'], 'United Internet Media GmbH': ['tifbs.net', 'ui-portal.de', 'uimserv.net'], 'realytics.io': ['realytics.io'], 'AdRiver': ['adriver.ru'], 'Fastly Insights': ['fastly-insights.com'], 'office.com': ['office.com'], 'Atlas': ['adbureau.net', 'atdmt.com', 'atlassbx.com'], 'PageFair': ['blockmetrics.com', 'pagefair.com', 'pagefair.net'], 'Browser Update': ['browser-update.org'], 'RawGit': ['rawgit.com'], 'True Anthem': ['tru.am'], 'Exactag': ['exactag.com'], 'exoticads': ['exoticads.com'], 'DigiTrust': ['digitru.st'], 'StickyAds': ['stickyadstv.com'], 'AdRecover': ['adrecover.com'], 'AdScale': ['adscale.de'], 'TVSquared': ['tvsquared.com'], 'dyncdn.me': ['dyncdn.me'], 'LiveChat': ['livechat.s3.amazonaws.com', 'livechatinc.com', 'livechatinc.net'], 'FullStory': ['fullstory.com'], 'Apple': ['apple.com'], 'statsy.net': ['statsy.net'], 'Bluecore': ['bluecore.com', 'triggeredmail.appspot.com'], 'Drawbridge': ['adsymptotic.com'], 'Treasure Data': ['treasuredata.com'], 'Adyoulike': ['adyoulike.com', 'omnitagjs.com'], 'LinkedIn Widgets': ['platform.linkedin.com'], 'Tradelab': ['tradelab.fr'], 'Spot.IM': ['spot.im'], 'Grapeshot': ['grapeshot.co.uk', 'gscontxt.net'], 'Truste Consent': ['consent.truste.com'], 'Enreach': ['adtlgc.com'], 'Webfonts by Hoefler&amp;Co': ['typography.com'], 'Relap': ['relap.io'], 'JivoSite': ['jivosite.com'], 'SiteScout by Centro': ['pixel.ad', 'sitescout.com'], 'Seznam': ['im.cz', 'imedia.cz', 'szn.cz'], 'Tail': ['tailtarget.com'], '[24]7': ['247-inc.net', 'd1af033869koo7.cloudfront.net'], 'faktor.io': ['faktor.io'], 'Visual IQ': ['myvisualiq.net'], 'Eloqua': ['eloqua.com', 'en25.com'], 'Google Trusted Stores': ['googlecommerce.com'], 'Allegro': ['allegroimg.com', 'allegrostatic.com', 'allegrostatic.pl', 'ngacm.com', 'ngastatic.com'], 'OLX': ['olx-st.com', 'onap.io'], 'Venatus Media': ['vntsm.com'], 'SoundCloud': ['sndcdn.com', 'soundcloud.com'], 'Line': ['line-apps.com', 'line-scdn.net', 'line.me'], 'Github Pages': ['github.io'], 'Heap': ['d36lvucg9kzous.cloudfront.net', 'heapanalytics.com'], 'Shopify CDN': ['shopifycdn.com'], 'Qualaroo': ['qualaroo.com'], 'Bitrix24': ['bitrix.de', 'bitrix.info', 'bitrix.ru', 'bitrix24.com', 'bitrix24.com.br'], 'Navegg': ['navdmp.com'], 'Pusher': ['pusher.com', 'pusherapp.com'], 'AdsKeeper': ['adskeeper.co.uk'], 'Bebi Media': ['bebi.com'], 'HookLogic': ['hlserve.com'], 'ORC International': ['emxdgt.com'], 'SendPulse': ['sendpulse.com'], 'Digiteka': ['digiteka.net', 'ultimedia.com'], 'Dropbox': ['dropbox.com', 'dropboxstatic.com'], 'Naver CDN': ['pstatic.net'], 'Scroll': ['scroll.com'], 'Zemanta': ['zemanta.com'], 'Internet BillBoard': ['bbelements.com', 'goadservices.com', 'ibillboard.com', 'mediainter.net'], 'InsightExpress': ['insightexpressai.com'], 'Curse CDN': ['cursecdn.com'], 'RevContent': ['revcontent.com'], 'TNS': ['research-int.se', 'sesamestats.com', 'spring-tns.net', 'statistik-gallup.net', 'tns-cs.net', 'tns-gallup.dk'], 'Connatix': ['connatix.com'], 'pub.network': ['pub.network'], 'The Guardian': ['gu-web.net', 'guardianapps.co.uk', 'guim.co.uk'], 'Quantcount': ['quantcount.com'], 'Naver': ['naver.com', 'naver.net'], 'Tribal Fusion': ['exponential.com', 'tribalfusion.com'], 'mbr targeting': ['m6r.eu'], 'DataXu': ['w55c.net'], 'Alipay': ['alipay.com'], 'Beachfront Media': ['bfmio.com'], 'BlueConic Plugin': ['blueconic.net'], 'Netflix': ['netflix.com', 'nflxext.com', 'nflximg.net', 'nflxso.net', 'nflxvideo.net'], 'Rocket Fuel': ['rfihub.com', 'rfihub.net', 'ru4.com', 'xplusone.com'], '1plusX': ['opecloud.com'], 'Elastic Ad': ['elasticad.net'], 'pendo': ['pendo.io'], 'ComScore, Inc.': ['comscore.com', 'zqtk.net'], 'Seeding Alliance': ['bacontent.de', 'nativendo.de'], 'Demandbase': ['company-target.com', 'demandbase.com'], 'Turner': ['turner.com'], 'Yandex.Advisor': ['metabar.ru'], 'RichRelevance': ['ics0.com', 'richrelevance.com'], 'Pardot': ['pardot.com'], 'Just Premium': ['justpremium.com', 'justpremium.nl'], 'G+J e|MS': ['emsservice.de'], 'Ad Alliance': ['adalliance.io'], 'Heroku': ['herokuapp.com'], 'Notify': ['adleadevent.com'], 'Ad Lightning': ['adlightning.com'], 'Yotpo': ['yotpo.com'], 'ad-blocker.org': ['ad-blocker.org'], 'AdFox': ['adfox.ru', 'adwolf.ru'], 'algolia': ['algolia.com', 'algolia.net'], 'Klaviyo': ['a.klaviyo.com'], 'Seedtag': ['seedtag.com'], 'Hola Player': ['h-cdn.com'], 'Accengage': ['accengage.net'], 'Admixer': ['admixer.net'], 'Wix': ['parastorage.com', 'wix.com'], 'Bombora': ['ml314.com'], 'Simpli.fi': ['simpli.fi'], 'Mapbox': ['mapbox.com'], 'CDN77': ['cdn77.com', 'cdn77.org'], 'Beeswax': ['bidr.io'], 'OwnerIQ': ['owneriq.net'], 'OptInMonster': ['mstrlytcs.com', 'optmnstr.com', 'optmstr.com', 'optnmstr.com'], 'boltdns.net': ['boltdns.net'], 'go.com': ['go.com'], 'UserReport': ['sdsbucket.s3.amazonaws.com', 'userreport.com'], 'DoubleVerify': ['doubleverify.com'], 'The Movie DB': ['tmdb.org'], 'Ninja Access Analysis': ['cho-chin.com', 'donburako.com', 'hishaku.com', 'shinobi.jp'], 'Heatmap': ['heatmap.it'], 'TripAdvisor': ['jscache.com', 'tacdn.com', 'tamgrt.com', 'tripadvisor.co.uk', 'tripadvisor.com', 'tripadvisor.de'], 'Sonobi': ['sonobi.com'], 'Booking.com': ['booking.com', 'bstatic.com'], 'Level 3 Communications, Inc.': ['footprint.net'], 'Samba TV': ['samba.tv'], 'Webedia': ['goutee.top', 'mediaathay.org.uk', 'wbdx.fr'], 'Pushwoosh': ['pushwoosh.com'], 'Intimate Merger': ['im-apps.net'], 'First Impression': ['firstimpression.io'], 'TrackJS': ['d2zah9y47r7bi2.cloudfront.net', 'dl1d2m8ri9v3j.cloudfront.net', 'trackjs.com'], 'Tawk': ['tawk.to'], 'Segmento': ['rutarget.ru'], 'Etsy CDN': ['etsystatic.com'], 'Adverticum': ['adverticum.net'], 'Digidip': ['digidip.net'], 'smi2.ru': ['smi2.net', 'smi2.ru'], 'Qubit Opentag': ['d3c3cq33003psk.cloudfront.net', 'qubit.com'], 'BloomReach': ['brcdn.com', 'brsrvr.com', 'brtstats.com'], 'Discord': ['discordapp.com'], '33Across': ['tynt.com'], 'Effective Measure': ['effectivemeasure.net'], 'ZergNet': ['zergnet.com'], 'Arc Publishing': ['arcpublishing.com'], 'gfycat': ['gfycat.com'], 'Eyeota': ['eyeota.net'], 'Dotmetrics': ['dotmetrics.net'], 'The New York Times': ['nyt.com'], 'Forter': ['forter.com'], 'iovation': ['iesnare.com', 'iovation.com'], 'Platform One': ['impact-ad.jp'], 'FastPic': ['fastpic.ru'], 'FreeWheel': ['fwmrm.net'], 'cdn13.com': ['cdn13.com'], 'Mail.Ru CDN': ['mycdn.me'], 'Ancestry CDN': ['ancestrycdn.com'], 'Insider': ['useinsider.com'], 'Lytics': ['lytics.io'], 'Sojern': ['sojern.com'], 'Maru-EDU': ['edigitalsurvey.com'], 'SessionCam': ['d2oh4tlt9mrke9.cloudfront.net', 'sessioncam.com'], 'ESPN CDN': ['espncdn.com'], 'TRUSTe Seal': ['privacy-policy.truste.com'], 'Supership': ['socdm.com'], 'Wirtualna Polska ': ['wp.pl', 'wpimg.pl'], 'trbo': ['trbo.com'], 'Urban Airship': ['urbanairship.com'], 'Get Site Control': ['getsitecontrol.com'], 'ipify': ['ipify.org'], 'Chatango': ['chatango.com'], 'Canvas': ['canvas.net', 'canvasnetwork.com', 'du11hjcvx0uqb.cloudfront.net'], 'DataTables': ['datatables.net'], 'SaleCycle': ['d16fk4ms6rqz1v.cloudfront.net', 'salecycle.com'], 'Blue Triangle': ['btttag.com'], 'ClickTripz': ['clicktripz.com'], 'Wix Media Platform': ['wixmp.com'], 'Creative Commons': ['creativecommons.org'], 'BetterTTV': ['betterttv.net'], 'Vk.com': ['cdn-vk.com', 'vk-analytics.com', 'vkuservideo.net'], 'The Weather Company': ['w-x.co', 'weather.com', 'wfxtriggers.com'], 'GetIntent': ['adhigh.net'], 'Atlassian': ['atl-paas.net', 'atlassian.com', 'atlassian.net', 'd12ramskps3070.cloudfront.net'], 'WonderPush': ['wonderpush.com'], 'sitelabweb.com': ['sitelabweb.com'], 'lentainform.com': ['lentainform.com'], 'Marin Search Marketer': ['marinsm.com'], 'TradeDoubler': ['tradedoubler.com'], '1DMP': ['1dmp.io'], 'Apester': ['apester.com'], 'ADmantX': ['admantx.com'], 'Flickr Badge': ['flickr.com', 'staticflickr.com'], 'Mercado': ['mercadoclics.com', 'mercadolivre.com.br', 'mlstatic.com'], 'Catchpoint': ['3gl.net'], 'IBM Digital Analytics': ['cmcore.com', 'coremetrics.com', 'coremetrics.eu'], 'remove.video': ['remove.video'], 'Braze': ['appboycdn.com'], 'Sumo': ['sumo.com', 'sumome.com'], 'Giphy': ['giphy.com'], 'Tremor Video': ['tremorhub.com', 'tremorvideo.com', 'videohub.tv']}


def is_valid_url(url):
    """Valide URLs Only. From only Django Source
    May update: https://github.com/django/django/blob/master/django/core/validators.py#L74"""
    regex = compile(
        r'^https?://'  # http:// or https://
        r'(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+[A-Z]{2,6}\.?|'  # domain...
        r'localhost|'  # localhost...
        r'\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})' # ...or ip
        r'(?::\d+)?'  # optional port
        r'(?:/?|[/?]\S+)$', IGNORECASE)
    return url is not None and regex.search(url)


def clean_url(url):
    """Ensure hostname is affixed to URL"""
    parse = urlparse(url)
    if parse[1] == '':
        url = 'https://' + parse[2]
    elif parse[0] not in ['https', 'http']:
        url = 'https://' + parse[1]
    return url


def get_calls(driver):
    """Get Network calls from browser.
    Stringify required to prevent cyclical error present in gecko driver """
    try:
        resources = driver.execute_script("return window.performance.getEntries();")
        print('NON_STRINGIFY')
        return [resource['name'] for resource in resources]
    except JavascriptException:
        resources = driver.execute_script("return JSON.stringify(window.performance.getEntries());")
        print('stringify')
        return [resource['name'] for resource in loads(resources)]


def get_network_dat(url, sleep_time):
    """Construct list of sites called through external network calls"""
    path_to_driver = '/home/ubuntu/track_proj/geckodriver'
    path_to_log = '/home/ubuntu/track_proj/geckodriver.log'
    options = webdriver.FirefoxOptions()
    options.headless = True
    driver = webdriver.Firefox(options=options, executable_path=path_to_driver, service_log_path=path_to_log)
    driver.set_page_load_timeout(100)
    try:
        driver.get(url)
        sleep(sleep_time + 3)
        calls = get_calls(driver)
        driver.quit()
        out = [i for i in calls]
        return get_network_trackers(out)
    except (TimeoutException, UnboundLocalError, WebDriverException, InvalidArgumentException):
        driver.quit()
        return {"Connection Error"}


def get_network_trackers(traff_urls):
    """Test network calls against list of known trackers.
    Return positive trackers found"""
    trackers = set()
    if len(traff_urls) > 0:
        for key, sites in tracker_set.items():
            for site, traff in product(sites, traff_urls):
                if traff.find(site) != -1:
                    trackers.add(key)
    return trackers


def get_raw_trackers(url):
    """Scan raw HTML for trackers"""
    raw_trackers = set()
    try:
        r = get(url, timeout=30)
        html = r.text
        for key, sites in tracker_set.items():
            for site in sites:
                if html.find(site) != -1:
                    raw_trackers.add(key)
        return raw_trackers
    except (ConnectionError, ReadTimeout):
        return {'Connection Error'}


def track_light(url, sleep_time):
    """Performs site analysis
        status == 0 Connection Error
        Status == 1 Trackers
        Status == 2 No Trackers
        Status == 3 Trouble Obtaining Network Data
        Status == 4 No Raw"""
    cleaned_url = clean_url(url)
    if is_valid_url(cleaned_url):
        net_traffic = get_network_dat(cleaned_url, sleep_time)
        raw_traffic = get_raw_trackers(cleaned_url)
        out = net_traffic.union(raw_traffic)
        if 'Connection Error' in out:
            if raw_traffic == {'Connection Error'} and net_traffic != {'Connection Error'}:
                if not net_traffic:
                    return [{'No Trackers'}, 2]
                else:
                    return [sorted(net_traffic), 4]
            elif net_traffic == {'Connection Error'} and raw_traffic != {'Connection Error'}:
                return [sorted(raw_traffic), 3]
            else:
                return [out, 0]
        elif out == set():
            return [{'No Trackers'}, 2]
        else:
            return [sorted(out), 1]
    else:
        return ['Bad URL', 5]
